<!doctype html>
<meta charset="utf-8">
<html>
    <head>
        <title>.gltf/.glb Viewer | Icosa Viewer</title>
        <style>
            html, body {
                height: 100%;
                width: 100%;
                margin: 0;
            }
        </style>
        <script type="importmap" class="es6_modules_map">
            {
                "imports": {
                    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.164.0/examples/jsm/",
                    "three/examples/": "https://cdn.jsdelivr.net/npm/three@0.164.0/examples/"
                }
            }
        </script>
        <link rel="stylesheet" href="css/style.css">
    </head>
    <body>
        <script type="module">
            import { Viewer } from "./icosa-viewer.module.js";
            import { GUI } from 'three/addons/libs/lil-gui.module.min.js';

            let viewer = new Viewer("https://icosa-foundation.github.io/icosa-sketch-assets/");
            let three = viewer.three;
            window.viewer = viewer;
            window.THREE = three;

                "camera": presentationParams.camera
            };

            let urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has("asset")) {
                let assetId = urlParams.get("asset");
                let metadataJson = await fetch(`https://api.icosa.gallery/v1/assets/${assetId}`);
                let json = await metadataJson.json();
                let formats = json.formats;
                let presentationParams = json.presentationParams;
                let overrides = {"camera": presentationParams.camera};
                for (const format of formats) {
                    if (format.formatType === "GLTF2") {
                        console.log(`Loading GLTF2 ${format.root.url}`);
                        await viewer.loadGltf(format.root.url, true, overrides);
                        break;
                    } else if (format.formatType === "GLTF") {
                        console.log(`Loading GLTF1 ${format.root.url}`);
                        await viewer.loadGltf1(format.root.url, true, overrides);
                        break;
                    }
                }
            } else {
                // Just some arbitrary values - not matching the actual asset
                let presentationParams = {"camera": {"type": "perspective", "rotation": [-0.1462917120878683, 0.2306854792441933, 0.03510497024615985, 0.9613275121956582], "perspective": {"yfov": 0, "znear": 0.1}, "translation": [1.586311936378479, 2.004192590713501, 3.153336048126221], "GOOGLE_camera_settings": null}, "colorSpace": "GAMMA", "backgroundColor": "#000000", "GOOGLE_hemi_light": null, "orientingRotation": {"w": 1}, "GOOGLE_backgrounds": {"color": [0, 0, 0]}, "GOOGLE_lighting_rig": null, "GOOGLE_geometry_data": null, "GOOGLE_scene_rotation": null, "GOOGLE_lights_image_based": null, "GOOGLE_real_world_transform": {"scaling_factor": 1}, "GOOGLE_initial_camera_motion": null};
            }
            const gui = new GUI( );

            const settings = {
                showEnvironment: true,
                showSky: true,
                readCam: () => {
                    let cameras = [];
                    viewer.scene.traverse((child) => {
                        if (child instanceof THREE.Camera) {
                            cameras.push(child);
                        }
                    });
                    console.log(cameras);
                }
            };

            gui.add( settings, 'showEnvironment' );
            gui.add( settings, 'showSky' );
            gui.add( settings, 'readCam').name("Read Camera");
            gui.onChange( update );
            update();

            function update() {
                viewer.environmentObject?.visible && (viewer.environmentObject.visible = settings.showEnvironment);
                viewer.skyObject?.visible && (viewer.skyObject.visible = settings.showSky);
            }
        </script>
        <div id="icosa-viewer"></div>
    </body>
</html>
